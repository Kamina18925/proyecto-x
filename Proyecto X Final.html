<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Pr√©stamos Personales PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos generales del cuerpo y comportamiento de scroll */
        body { font-family: 'Inter', sans-serif; overscroll-behavior-y: none; }

        /* Estilos para el popup de mensajes */
        .message-popup {
            position: fixed; top: 20px; right: 20px; padding: 1rem; border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 1050;
            transition: opacity 0.5s ease-in-out, transform 0.3s ease-in-out;
            opacity: 0; transform: translateY(-20px); pointer-events: none;
        }
        /* Clase para mostrar el popup */
        .message-popup.show { opacity: 1; transform: translateY(0); pointer-events: auto; }
        /* Estilos por tipo de mensaje */
        .message-popup.success { background-color: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
        .message-popup.error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .message-popup.info { background-color: #e0f2fe; color: #075985; border: 1px solid #7dd3fc; }
        .message-popup.warning { background-color: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }

        /* Transiciones para botones */
        button { transition: all 0.15s ease-in-out; }
        button:hover { transform: translateY(-1px); filter: brightness(1.05); }
        button:active { transform: translateY(0px); filter: brightness(0.95); }

        /* Clases para ocultar secciones */
        .admin-section, .modal-overlay { display: none; }

        /* Estilos para el overlay de modales */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); z-index: 1000;
            display: flex; align-items: center; justify-content: center;
        }
        /* Estilos para el contenido del modal */
        .modal-content {
            background-color: white; padding: 2rem; border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%; max-width: 600px;
            max-height: 90vh; overflow-y: auto;
        }

        /* Estilo espec√≠fico para hacer m√°s ancha la ventana de Ver Pagos */
        #viewPaymentsModal .modal-content {
            max-width: 800px; /* Aumentado de 600px a 800px */
        }

        /* Estilos para tablas responsivas */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #e5e7eb; padding: 0.75rem; text-align: left; white-space: nowrap; }
        th { background-color: #f9fafb; }

        /* Estilos para celdas truncadas con tooltip */
        td.truncate-tooltip { max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; position: relative; }
        td.truncate-tooltip:hover .tooltiptext-cell { visibility: visible; opacity: 1; }
        .tooltiptext-cell {
            visibility: hidden; background-color: #333; color: #fff; text-align: center;
            border-radius: 6px; padding: 8px; position: absolute; z-index: 10;
            bottom: 100%; left: 50%; transform: translateX(-50%); margin-bottom: 5px;
            opacity: 0; transition: opacity 0.3s; white-space: normal; width: max-content; max-width: 300px;
            font-size: 0.875rem; line-height: 1.25rem;
        }

        /* Ocultar flechas de input number */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* Estilos para impresi√≥n */
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea {
                position: absolute; left: 0; top: 0; width: 100%; padding: 20px;
                font-family: 'Arial', sans-serif; font-size: 12px; color: #000;
            }
            #printArea h1, #printArea h2, #printArea h3, #printArea h4 {
                color: #000 !important; margin-bottom: 10px; font-weight: bold;
            }
            #printArea table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 10px; }
            #printArea th, #printArea td { border: 1px solid #ccc; padding: 4px; text-align: left; }
            #printArea th { background-color: #f0f0f0; }
            #printArea .no-print { display: none; }
            /* Ocultar elementos no deseados en la impresi√≥n */
            .modal-overlay, .message-popup, #mainFormContainer, #adminSection header,
            #adminSection .grid.gap-4.mb-6, /* Estad√≠sticas globales */
            #adminSection .my-6.p-4.border, /* Gesti√≥n de datos globales */
            #adminSection .flex.flex-col.md\\:flex-row.md\\:space-x-4.mb-4, /* Contenedor de filtros */
            #adminSection .overflow-x-auto table thead tr th:last-child, /* Columna de acciones */
            #adminSection .overflow-x-auto table tbody tr td:last-child /* Columna de acciones */
            { display: none !important; }
            #adminSection .overflow-x-auto table { margin-top: 0; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
    <input type="hidden" id="editingLoanId" value="">

    <div id="mainFormContainer" class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-3xl">
        <header class="mb-6 sm:mb-8 text-center">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Gestor de Pr√©stamos Personales PRO</h1>
        </header>

        <form id="loanForm" class="space-y-6">
             <fieldset class="border border-gray-300 p-4 rounded-lg">
                <legend class="text-lg font-semibold text-gray-700 px-2">Datos del Cliente</legend>
                <div class="space-y-4 mt-2">
                    <div>
                        <label for="nombre" class="block text-sm font-medium text-gray-700">Nombre Completo:</label>
                        <input type="text" id="nombre" name="nombre" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="direccion" class="block text-sm font-medium text-gray-700">Direcci√≥n:</label>
                            <input type="text" id="direccion" name="direccion" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                        <div>
                            <label for="telefono" class="block text-sm font-medium text-gray-700">Tel√©fono:</label>
                            <input type="tel" id="telefono" name="telefono" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email (Opcional):</label>
                        <input type="email" id="email" name="email" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
            </fieldset>

            <fieldset class="border border-gray-300 p-4 rounded-lg">
                <legend class="text-lg font-semibold text-gray-700 px-2">Datos del Pr√©stamo</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                    <div>
                        <label for="fechaPrestamo" class="block text-sm font-medium text-gray-700">Fecha del Pr√©stamo:</label>
                        <input type="date" id="fechaPrestamo" name="fechaPrestamo" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="importeCredito" class="block text-sm font-medium text-gray-700">Importe del Cr√©dito (RD$):</label>
                        <input type="text" id="importeCredito" name="importeCredito" placeholder="Ej: 20,000.00" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="modalidadPago" class="block text-sm font-medium text-gray-700">Modalidad de Pago:</label>
                        <select id="modalidadPago" name="modalidadPago" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="Mensual" selected>Mensual</option>
                            <option value="Quincenal">Quincenal</option>
                            <option value="Semanal">Semanal</option>
                        </select>
                    </div>
                    <div>
                        <label for="tasaInteresValor" class="block text-sm font-medium text-gray-700">Tasa de Inter√©s Fijo (% sobre capital):</label>
                        <input type="text" id="tasaInteresValor" name="tasaInteresValor" placeholder="Ej: 20.00 (para 20%)" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="tipoTasa" class="block text-sm font-medium text-gray-700">Tipo de Tasa (Informativo):</label>
                        <select id="tipoTasa" name="tipoTasa" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="Unica" selected>√önica (Fija sobre capital)</option>
                            <option value="Anual">Anual (Referencia)</option>
                            <option value="Mensual">Mensual (Referencia)</option>
                        </select>
                    </div>
                    <div>
                        <label for="numeroCuotas" class="block text-sm font-medium text-gray-700">N√∫mero de Cuotas:</label>
                        <input type="number" id="numeroCuotas" name="numeroCuotas" min="1" step="1" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                     <div>
                        <label for="llevoContrato" class="block text-sm font-medium text-gray-700">¬øLlev√≥ Contrato?</label>
                        <select id="llevoContrato" name="llevoContrato" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="No" selected>No</option>
                            <option value="Si">S√≠</option>
                        </select>
                    </div>
                    <div id="costoContratoContainer" class="hidden">
                        <label for="costoContrato" class="block text-sm font-medium text-gray-700">Costo del Contrato (RD$0-RD$5,000):</label>
                        <input type="text" id="costoContrato" name="costoContrato" placeholder="Ej: 500.00 (0-5,000)" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div id="costoContratoPagadoContainer" class="hidden md:col-span-2">
                        <label for="costoContratoPagado" class="block text-sm font-medium text-gray-700">¬øCosto del Contrato Pagado por Adelantado?</label>
                        <select id="costoContratoPagado" name="costoContratoPagado" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="No" selected>No (se incluir√° en el financiamiento)</option>
                            <option value="Si">S√≠ (pagado aparte)</option>
                        </select>
                    </div>
                    <div>
                        <label for="garantia" class="block text-sm font-medium text-gray-700">¬øDej√≥ Garant√≠a?</label>
                        <select id="garantia" name="garantia" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                            <option value="No" selected>No</option>
                            <option value="Si">S√≠</option>
                        </select>
                    </div>
                    <div id="detallesGarantiaContainer" class="hidden md:col-span-2">
                        <label for="detallesGarantia" class="block text-sm font-medium text-gray-700">Detalles de la Garant√≠a:</label>
                        <textarea id="detallesGarantia" name="detallesGarantia" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Describa la garant√≠a dejada por el cliente..."></textarea>
                    </div>
                </div>
            </fieldset>

            <fieldset class="border border-gray-300 p-4 rounded-lg bg-gray-50">
                <legend class="text-lg font-semibold text-gray-700 px-2">Resultados del Pr√©stamo (Inter√©s Fijo sobre Capital)</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                    <div>
                        <p class="block text-sm font-medium text-gray-700">Cuota por Per√≠odo Estimada:</p>
                        <p id="cuotaPeriodica" class="mt-1 text-xl font-semibold text-indigo-600">RD$0.00</p>
                    </div>
                    <div>
                        <p class="block text-sm font-medium text-gray-700">Inter√©s Total Estimado (sobre capital):</p>
                        <p id="interesTotalDisplay" class="mt-1 text-xl font-semibold text-indigo-600">RD$0.00</p>
                    </div>
                    <div class="md:col-span-2">
                        <p class="block text-sm font-medium text-gray-700">Total General a Pagar Estimado:</p>
                        <p id="totalPagar" class="mt-1 text-xl font-semibold text-indigo-600">RD$0.00</p>
                    </div>
                </div>
            </fieldset>

            <div class="flex flex-col sm:flex-row sm:justify-between items-center space-y-3 sm:space-y-0 sm:space-x-3 pt-4">
                <button type="button" id="adminAccessBtn" class="w-full sm:w-auto px-4 py-2 border border-purple-500 rounded-md shadow-sm text-sm font-medium text-purple-700 bg-purple-100 hover:bg-purple-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                    Acceder a Administraci√≥n
                </button>
                <div class="flex flex-col sm:flex-row sm:justify-end space-y-3 sm:space-y-0 sm:space-x-3 w-full sm:w-auto">
                    <button type="button" id="calculateBtn" class="w-full sm:w-auto px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Calcular Pr√©stamo
                    </button>
                    <button type="button" id="saveBtn" class="w-full sm:w-auto px-4 py-2 border border-green-500 rounded-md shadow-sm text-sm font-medium text-green-700 bg-green-100 hover:bg-green-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                        Guardar Datos (en Navegador)
                    </button>
                    <button type="button" id="clearBtn" class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Limpiar Formulario
                    </button>
                </div>
            </div>
        </form>
        <footer class="mt-8 text-center text-sm text-gray-500">
            <p>Nota: Al guardar, los datos se almacenan localmente en su navegador.</p>
            <p class="mt-1">Para crear un respaldo en un archivo f√≠sico o importar datos, acceda a la secci√≥n de Administraci√≥n.</p>
        </footer>
    </div>

    <div id="adminSection" class="admin-section bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-7xl mt-10 hidden">
        <header class="mb-6 sm:mb-8 flex flex-col sm:flex-row justify-between items-center gap-4">
            <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">Administraci√≥n de Pr√©stamos</h2>
            <button type="button" id="backToFormBtn" class="w-full sm:w-auto px-4 py-2 border border-indigo-500 rounded-md shadow-sm text-sm font-medium text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                Volver al Formulario
            </button>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="bg-white rounded-xl shadow p-4">
            <p class="text-sm text-gray-500">Capital Prestado Total</p>
            <p class="text-2xl font-bold text-blue-600" id="totalCapitalPrestado">RD$0.00</p>
          </div>
          <div class="bg-white rounded-xl shadow p-4">
            <p class="text-sm text-gray-500">Inter√©s Original Pagado</p>
            <p class="text-2xl font-bold text-green-600" id="totalInteresGanadoGlobal">RD$0.00</p>
          </div>
          <div class="bg-white rounded-xl shadow p-4">
            <p class="text-sm text-gray-500">Mora Pagada</p>
            <p class="text-2xl font-bold text-orange-500" id="totalMoraGanadaGlobal">RD$0.00</p>
          </div>
          <div class="bg-white rounded-xl shadow p-4">
            <p class="text-sm text-gray-500">Ganancia Total (Int. + Mora Pagados)</p>
            <p class="text-2xl font-bold text-purple-600" id="totalGananciaGlobal">RD$0.00</p>
          </div>
        </div>

        <div class="my-6 p-4 border border-gray-300 rounded-lg bg-gray-50">
            <h4 class="text-lg font-semibold text-gray-800 mb-3">Gesti√≥n de Datos Globales</h4>
            <div class="flex flex-wrap gap-3 items-center">
                <button type="button" id="exportAllDataBtn" class="px-4 py-2 border border-blue-600 text-blue-700 bg-blue-100 hover:bg-blue-200 rounded-md text-sm font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500">Crear/Actualizar Respaldo (JSON)</button>
                <label for="importFile" class="px-4 py-2 border border-green-600 text-green-700 bg-green-100 hover:bg-green-200 rounded-md text-sm font-medium cursor-pointer shadow-sm focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-1 focus-within:ring-green-500">
                    <span>Importar Respaldo (JSON)</span>
                    <input type="file" id="importFile" class="sr-only" accept=".json">
                </label>
                <button type="button" id="printGlobalReportsBtn" class="px-4 py-2 border border-teal-600 text-teal-700 bg-teal-100 hover:bg-teal-200 rounded-md text-sm font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-teal-500">
                    Imprimir Reportes Globales üñ®Ô∏è
                </button>
            </div>
            <div class="mt-3">
                 <p class="text-sm text-gray-600">Clientes en Mora Activa: <span id="clientesEnMoraGlobal" class="font-semibold text-red-600">0</span></p>
            </div>
            <p class="text-xs text-gray-500 mt-2">Al crear un respaldo, se descargar√° un archivo JSON. Si ya existe uno con el mismo nombre, su navegador le permitir√° reemplazarlo. Guarde este archivo en un lugar seguro. Al importar, los datos actuales en el navegador ser√°n reemplazados.</p>
        </div>

        <div class="flex flex-col md:flex-row md:space-x-4 mb-4">
            <div class="w-full md:w-1/2 mb-4 md:mb-0">
                <label for="filterLoans" class="block text-sm font-medium text-gray-700">Filtrar Pr√©stamos:</label>
                <select id="filterLoans" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    <option value="TodosActivos" selected>Todos (Activos)</option>
                    <option value="Todos">Todos (Incluye Pagados)</option>
                    <option value="Pagados">Pagados (Saldo <= 0)</option>
                    <option value="Mensual">Mensual (Activos)</option>
                    <option value="Quincenal">Quincenal (Activos)</option>
                    <option value="Semanal">Semanal (Activos)</option>
                </select>
            </div>
            <div class="w-full md:w-1/2">
                <label for="filterClients" class="block text-sm font-medium text-gray-700">Filtrar Clientes (por nombre):</label>
                <input type="text" id="filterClients" placeholder="Escriba nombre del cliente..." class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
            </div>
        </div>

        <div class="overflow-x-auto shadow rounded-xl border border-gray-200">
          <table id="loansTable" class="min-w-full text-sm text-left text-gray-700">
            <thead class="bg-gray-50 text-xs uppercase text-gray-500 tracking-wider">
              <tr>
                <th class="px-6 py-4">Cliente</th>
                <th class="px-6 py-4">Monto (RD$)</th>
                <th class="px-6 py-4">Tasa (%)</th>
                <th class="px-6 py-4">Cuota (RD$)</th>
                <th class="px-6 py-4">Inter√©s Orig. Pagado</th>
                <th class="px-6 py-4">Mora Acum. (Cargada)</th>
                <th class="px-6 py-4">Saldo Pend.</th>
                <th class="px-6 py-4">Garant√≠a</th>
                <th class="px-6 py-4">Acciones</th>
              </tr>
            </thead>
            <tbody id="loansTableBody" class="bg-white divide-y divide-gray-100"></tbody>
          </table>
        </div>
        <p id="noLoansMessage" class="text-center text-gray-500 py-4 hidden">No hay pr√©stamos registrados que coincidan con los filtros actuales.</p>
    </div>

    <div id="loginModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Acceso de Administrador</h3>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700">Usuario:</label>
                    <input type="text" id="username" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700">Contrase√±a:</label>
                    <input type="password" id="password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelLoginBtn" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">Cancelar</button>
                    <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">Ingresar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="paymentModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4">Registrar Pago para <span id="paymentModalLoanClient"></span></h3>
            <form id="paymentForm">
                <input type="hidden" id="paymentLoanId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="fechaPagoModal" class="block text-sm font-medium text-gray-700">Fecha de Pago:</label>
                        <input type="date" id="fechaPagoModal" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="montoPagadoModal" class="block text-sm font-medium text-gray-700">Monto Pagado (RD$):</label>
                        <input type="text" id="montoPagadoModal" placeholder="Ej: 1,000.00" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="tipoPagoModal" class="block text-sm font-medium text-gray-700">Tipo de Pago:</label>
                    <select id="tipoPagoModal" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="interes_capital" selected>Inter√©s y Capital (Abono a deuda total)</option>
                        <option value="solo_interes">Solo Inter√©s (No reduce saldo pendiente de capital)</option>
                        </select>
                </div>
                <div class="mt-4">
                    <label for="notasPagoModal" class="block text-sm font-medium text-gray-700">Notas (Opcional):</label>
                    <textarea id="notasPagoModal" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
                 <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" id="cancelPaymentBtn" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">Cancelar</button>
                    <button type="submit" class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">Registrar Pago</button>
                </div>
            </form>
        </div>
    </div>

    <div id="viewPaymentsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Historial de Pagos: <span id="viewPaymentsModalClientName"></span></h3>
                <button type="button" id="closeViewPaymentsModalBtn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="paymentsHistoryContainer" class="max-h-[70vh] overflow-y-auto"></div>
        </div>
    </div>

    <div id="globalPrintOptionsModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-6">Opciones de Impresi√≥n Global</h3>
            <div class="space-y-4">
                <button type="button" id="printActiveLoansBtn" class="w-full px-4 py-2 border border-blue-500 text-blue-700 bg-blue-100 hover:bg-blue-200 rounded-md shadow-sm">Imprimir Pr√©stamos Activos (Pendientes)</button>
                <button type="button" id="printInactiveLoansBtn" class="w-full px-4 py-2 border border-green-500 text-green-700 bg-green-100 hover:bg-green-200 rounded-md shadow-sm">Imprimir Pr√©stamos Inactivos (Pagados)</button>

                <div class="pt-4 border-t">
                    <label for="selectClientForReceipt" class="block text-sm font-medium text-gray-700 mb-1">Imprimir Recibo de Pago para Cliente:</label>
                    <select id="selectClientForReceipt" class="w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">-- Seleccione un Cliente --</option>
                        </select>
                    <button type="button" id="printSelectedClientReceiptBtn" class="mt-3 w-full px-4 py-2 border border-purple-500 text-purple-700 bg-purple-100 hover:bg-purple-200 rounded-md shadow-sm">Generar Recibo</button>
                </div>
            </div>
            <div class="mt-8 flex justify-end">
                <button type="button" id="cancelGlobalPrintBtn" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Panel de gesti√≥n de administradores (solo visible para Kamina) -->
    <div id="adminsPanel" class="admin-section bg-white p-6 rounded-xl shadow-xl w-full max-w-2xl mt-8 hidden">
        <h3 class="text-xl font-bold mb-4">Gesti√≥n de Administradores</h3>
        <form id="addAdminForm" class="flex flex-col sm:flex-row gap-3 mb-4">
            <input type="text" id="newAdminUser" placeholder="Nuevo usuario" required class="flex-1 px-3 py-2 border rounded-md">
            <input type="password" id="newAdminPass" placeholder="Contrase√±a" required class="flex-1 px-3 py-2 border rounded-md">
            <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-md">Agregar</button>
        </form>
        <ul id="adminsList" class="space-y-2"></ul>
    </div>

    <div id="printArea" class="hidden"></div>
    <div id="messageArea" class="message-popup"></div>

    <script>
        // Referencias a elementos del DOM
        const mainFormContainer = document.getElementById('mainFormContainer');
        const adminSection = document.getElementById('adminSection');
        const loanForm = document.getElementById('loanForm');
        const nombreInput = document.getElementById('nombre');
        const direccionInput = document.getElementById('direccion');
        const telefonoInput = document.getElementById('telefono');
        const emailInput = document.getElementById('email');
        const fechaPrestamoInput = document.getElementById('fechaPrestamo');
        const importeCreditoInput = document.getElementById('importeCredito');
        const modalidadPagoSelect = document.getElementById('modalidadPago');
        const tasaInteresValorInput = document.getElementById('tasaInteresValor');
        const tipoTasaSelect = document.getElementById('tipoTasa');
        const numeroCuotasInput = document.getElementById('numeroCuotas');
        const llevoContratoSelect = document.getElementById('llevoContrato');
        const costoContratoContainer = document.getElementById('costoContratoContainer');
        const costoContratoInput = document.getElementById('costoContrato');
        const costoContratoPagadoContainer = document.getElementById('costoContratoPagadoContainer');
        const costoContratoPagadoSelect = document.getElementById('costoContratoPagado');
        const garantiaSelect = document.getElementById('garantia');
        const detallesGarantiaContainer = document.getElementById('detallesGarantiaContainer');
        const detallesGarantiaInput = document.getElementById('detallesGarantia');
        const cuotaPeriodicaDisplay = document.getElementById('cuotaPeriodica');
        const totalPagarDisplay = document.getElementById('totalPagar');
        const interesTotalDisplay = document.getElementById('interesTotalDisplay');

        const calculateBtn = document.getElementById('calculateBtn');
        const saveBtn = document.getElementById('saveBtn');
        const clearBtn = document.getElementById('clearBtn');
        const adminAccessBtn = document.getElementById('adminAccessBtn');
        const backToFormBtn = document.getElementById('backToFormBtn');
        const messageArea = document.getElementById('messageArea');
        let messageTimeout;

        const totalCapitalPrestadoDisplay = document.getElementById('totalCapitalPrestado');
        const totalInteresGanadoGlobalDisplay = document.getElementById('totalInteresGanadoGlobal');
        const totalMoraGanadaGlobalDisplay = document.getElementById('totalMoraGanadaGlobal');
        const totalGananciaGlobalDisplay = document.getElementById('totalGananciaGlobal');
        const clientesEnMoraGlobalDisplay = document.getElementById('clientesEnMoraGlobal');

        const filterLoansSelect = document.getElementById('filterLoans');
        const filterClientsInput = document.getElementById('filterClients');

        const loginModal = document.getElementById('loginModal');
        const loginFormElement = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const cancelLoginBtn = document.getElementById('cancelLoginBtn');
        const loansTableBody = document.getElementById('loansTableBody');
        const noLoansMessage = document.getElementById('noLoansMessage');

        const paymentModal = document.getElementById('paymentModal');
        const paymentFormElement = document.getElementById('paymentForm');
        const paymentLoanIdInput = document.getElementById('paymentLoanId');
        const paymentModalLoanClient = document.getElementById('paymentModalLoanClient');
        const fechaPagoInputModal = document.getElementById('fechaPagoModal');
        const montoPagadoInputModal = document.getElementById('montoPagadoModal');
        const tipoPagoSelectModal = document.getElementById('tipoPagoModal');
        const notasPagoInputModal = document.getElementById('notasPagoModal');
        const cancelPaymentBtn = document.getElementById('cancelPaymentBtn');

        const viewPaymentsModal = document.getElementById('viewPaymentsModal');
        const viewPaymentsModalClientName = document.getElementById('viewPaymentsModalClientName');
        const paymentsHistoryContainer = document.getElementById('paymentsHistoryContainer');
        const closeViewPaymentsModalBtn = document.getElementById('closeViewPaymentsModalBtn');

        const exportAllDataBtn = document.getElementById('exportAllDataBtn');
        const importFileInput = document.getElementById('importFile');
        const editingLoanIdInput = document.getElementById('editingLoanId');
        const printArea = document.getElementById('printArea');

        const printGlobalReportsBtn = document.getElementById('printGlobalReportsBtn');
        const globalPrintOptionsModal = document.getElementById('globalPrintOptionsModal');
        const printActiveLoansBtn = document.getElementById('printActiveLoansBtn');
        const printInactiveLoansBtn = document.getElementById('printInactiveLoansBtn');
        const selectClientForReceipt = document.getElementById('selectClientForReceipt');
        const printSelectedClientReceiptBtn = document.getElementById('printSelectedClientReceiptBtn');
        const cancelGlobalPrintBtn = document.getElementById('cancelGlobalPrintBtn');

        let loansData = [];
let sesionActiva = false;
let usuarioActual = null; // Nuevo: para saber qui√©n est√° logueado

        // Variable para gestionar la edici√≥n de un pago
        let currentEditingPaymentInfo = { loanId: null, pagoIndex: -1 };


        // --- FUNCIONES DE UTILIDAD ---
        function formatNumberRD(num, minimumFractionDigits = 2, maximumFractionDigits = 2) {
            const number = Number(num);
            if (isNaN(number)) return '0.00';
            let fixedNumStr = number.toFixed(maximumFractionDigits);
            let parts = fixedNumStr.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            if (parts.length === 1 && minimumFractionDigits > 0) parts.push('0'.repeat(minimumFractionDigits));
            else if (parts.length > 1 && parts[1].length < minimumFractionDigits) parts[1] = parts[1].padEnd(minimumFractionDigits, '0');
            return parts.join(".");
        }

        function parseFlexibleFloat(value) {
            if (typeof value !== 'string' || value.trim() === '') return NaN;
            const valueWithoutThousandSeparators = value.replace(/,(?=\d{3}(?!\d))/g, '');
            const normalizedValue = valueWithoutThousandSeparators.replace(',', '.');
            return parseFloat(normalizedValue);
        }

        function showMessage(text, type = 'info', duration = 4000) {
            messageArea.textContent = text;
            messageArea.className = 'message-popup show';
            if (type === 'success') messageArea.classList.add('success');
            else if (type === 'error') messageArea.classList.add('error');
            else if (type === 'warning') messageArea.classList.add('warning');
            else messageArea.classList.add('info');
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => messageArea.classList.remove('show'), duration);
        }

        function calculateDueDateForNthInstallment(startDateString, modality, n) {
            const startDate = new Date(startDateString + 'T00:00:00');
            if (isNaN(startDate.getTime())) return null;
            let dueDate = new Date(startDate);
            for (let i = 0; i < n; i++) {
                switch (modality) {
                    case 'Mensual': dueDate.setMonth(dueDate.getMonth() + 1); break;
                    case 'Quincenal': dueDate.setDate(dueDate.getDate() + 15); break;
                    case 'Semanal': dueDate.setDate(dueDate.getDate() + 7); break;
                    default: return null;
                }
            }
            return dueDate.toISOString().split('T')[0];
        }

        // --- INICIALIZACI√ìN ---
        document.addEventListener('DOMContentLoaded', () => {
            fechaPrestamoInput.valueAsDate = new Date();
            fechaPagoInputModal.valueAsDate = new Date();

            loadLoansFromLocalStorage();
            checkAndApplyMoraToAllLoans(); // Apply mora on load
            updateAdminTable();
            updateGlobalStats();

            llevoContratoSelect.addEventListener('change', toggleCostoContrato);
            garantiaSelect.addEventListener('change', toggleDetallesGarantia);

            exportAllDataBtn.addEventListener('click', exportAllData);
            importFileInput.addEventListener('change', importData);

            printGlobalReportsBtn.addEventListener('click', openGlobalPrintOptionsModal);
            cancelGlobalPrintBtn.addEventListener('click', () => globalPrintOptionsModal.style.display = 'none');
            printActiveLoansBtn.addEventListener('click', handlePrintActiveLoans);
            printInactiveLoansBtn.addEventListener('click', handlePrintInactiveLoans);
            printSelectedClientReceiptBtn.addEventListener('click', handlePrintSelectedClientReceipt);

            filterLoansSelect.addEventListener('change', updateAdminTable);
            if (filterClientsInput) {
                filterClientsInput.addEventListener('input', updateAdminTable);
            }

            toggleCostoContrato();
            toggleDetallesGarantia();
            clearDisplayResults();

            window.addEventListener('beforeunload', handleBeforeUnload);
        });

        function handleBeforeUnload(event) {
            if (localStorage.getItem('gestorPrestamosDataPRO')) {
                const confirmationMessage = 'Tienes datos de pr√©stamos guardados localmente. ¬øEst√°s seguro de que quieres salir sin crear un respaldo (JSON)?';
                event.returnValue = confirmationMessage;
                return confirmationMessage;
            }
        }

        function clearDisplayResults() {
            cuotaPeriodicaDisplay.textContent = `RD$${formatNumberRD(0)}`;
            totalPagarDisplay.textContent = `RD$${formatNumberRD(0)}`;
            interesTotalDisplay.textContent = `RD$${formatNumberRD(0)}`;
        }

        function toggleCostoContrato() {
            const show = llevoContratoSelect.value === 'Si';
            costoContratoContainer.classList.toggle('hidden', !show);
            costoContratoPagadoContainer.classList.toggle('hidden', !show);
            if (show) {
                costoContratoInput.setAttribute('required', 'required');
                costoContratoInput.placeholder = 'Ej: 500.00 (0-5,000)';
            } else {
                costoContratoInput.removeAttribute('required');
                costoContratoInput.value = '';
                costoContratoPagadoSelect.value = 'No';
                costoContratoInput.placeholder = 'Ej: 500.00';
            }
        }

        function toggleDetallesGarantia() {
            detallesGarantiaContainer.classList.toggle('hidden', garantiaSelect.value !== 'Si');
            if (garantiaSelect.value !== 'Si') detallesGarantiaInput.value = '';
        }

        // --- L√ìGICA PRINCIPAL DEL PR√âSTAMO ---
        function validateMainForm() {
            if (!nombreInput.value.trim()) { showMessage('El nombre del cliente es obligatorio.', 'error'); nombreInput.focus(); return false; }
            if (!fechaPrestamoInput.value) { showMessage('La fecha del pr√©stamo es obligatoria.', 'error'); fechaPrestamoInput.focus(); return false; }
            const importe = parseFlexibleFloat(importeCreditoInput.value);
            if (isNaN(importe) || importe <= 0) { showMessage('El importe del cr√©dito debe ser un n√∫mero positivo.', 'error'); importeCreditoInput.focus(); return false; }
            const tasaValor = parseFlexibleFloat(tasaInteresValorInput.value);
            if (isNaN(tasaValor) || tasaValor < 0) { showMessage('La tasa de inter√©s debe ser un n√∫mero positivo o cero.', 'error'); tasaInteresValorInput.focus(); return false; }
            const cuotas = parseInt(numeroCuotasInput.value);
            if (isNaN(cuotas) || cuotas <= 0) { showMessage('El n√∫mero de cuotas debe ser un entero positivo.', 'error'); numeroCuotasInput.focus(); return false; }
            if (emailInput.value.trim() && !emailInput.value.includes('@')) { showMessage('Por favor, ingrese un email v√°lido o d√©jelo vac√≠o.', 'error'); emailInput.focus(); return false; }

            let costoContratoVal = 0;
            if (llevoContratoSelect.value === 'Si') {
                costoContratoVal = parseFlexibleFloat(costoContratoInput.value);
                if (isNaN(costoContratoVal) || costoContratoVal < 0 || costoContratoVal > 5000) {
                    showMessage('El costo del contrato debe estar entre RD$0 y RD$5,000.', 'error');
                    costoContratoInput.focus(); return false;
                }
            }
            return { importe, tasaValor, cuotas, costoContrato: costoContratoVal };
        }

        function calculateLoan() {
            const validationResult = validateMainForm();
            if (!validationResult) { clearDisplayResults(); return null; }
            const { importe: capital, tasaValor, cuotas: numCuotasTotal, costoContrato: costoDelContratoNumerico } = validationResult;

            const interesSobreCapitalOriginal = capital * (tasaValor / 100);
            let totalGeneralAPagar = capital + interesSobreCapitalOriginal;
            let costoContratoFinal = 0, costoContratoFinanciado = 0, costoContratoAdelantado = 0;

            if (llevoContratoSelect.value === 'Si') {
                costoContratoFinal = costoDelContratoNumerico;
                if (costoContratoPagadoSelect.value === 'No') {
                    totalGeneralAPagar += costoContratoFinal;
                    costoContratoFinanciado = costoContratoFinal;
                } else {
                    costoContratoAdelantado = costoContratoFinal;
                }
            }

            const cuotaCalculada = numCuotasTotal > 0 ? totalGeneralAPagar / numCuotasTotal : 0;

            cuotaPeriodicaDisplay.textContent = `RD$${formatNumberRD(cuotaCalculada)}`;
            totalPagarDisplay.textContent = `RD$${formatNumberRD(totalGeneralAPagar)}`;
            interesTotalDisplay.textContent = `RD$${formatNumberRD(interesSobreCapitalOriginal)}`;

            return {
                cuotaPeriodica: cuotaCalculada, totalPagar: totalGeneralAPagar, interesTotal: interesSobreCapitalOriginal,
                costoContratoAplicado: costoContratoFinal, costoContratoIncluidoEnFinanciamiento: costoContratoFinanciado,
                costoContratoPagadoPorAdelantado: costoContratoAdelantado
            };
        }

        // --- L√ìGICA DE MORA ---
        function checkAndApplyMoraToAllLoans() {
            const today = new Date();
            today.setHours(0,0,0,0);

            loansData.forEach(loan => {
                // If loan is paid or has zero remaining balance (allowing for floating point inaccuracies)
                if (loan.saldoPendiente <= 0.005) {
                     loan.cuotasEnMora = 0;
                     loan.moraAcumulada = 0; // Ensure mora is zero if loan is paid off
                     if (loan.saldoPendiente < 0.005 && loan.saldoPendiente > -0.005) loan.saldoPendiente = 0;
                     return;
                }

                let totalPotentialMoraFromOverdueCuotas = 0;
                let currentCuotasEnMoraCount = 0;

                // Calculate total potential mora from all currently overdue cuotas
                for (let i = 0; i < loan.numeroCuotas; i++) {
                    const numeroDeEstaCuota = i + 1;
                    const fechaVencimientoEstaCuota = calculateDueDateForNthInstallment(loan.fechaPrestamo, loan.modalidadPago, numeroDeEstaCuota);
                    if (!fechaVencimientoEstaCuota) continue; // Skip if date calculation failed

                    const fechaVencimientoDate = new Date(fechaVencimientoEstaCuota + 'T00:00:00');
                    const diffTime = today - fechaVencimientoDate;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    // Check if the cuota is overdue by more than 5 days
                    if (diffDays > 5) {
                        const moraForThisCuota = loan.cuotaPeriodica * 0.10; // 10% of the original cuota amount
                        totalPotentialMoraFromOverdueCuotas += moraForThisCuota;
                        currentCuotasEnMoraCount++; // Count this cuota as being in mora
                    }
                }

                // Calculate total mora paid off across all payments
                const totalMoraPaid = (loan.pagos || []).reduce((sum, p) => sum + (p.montoAplicadoAMora || 0), 0);

                // Calculate the actual pending mora
                const newMoraAcumulada = Math.max(0, totalPotentialMoraFromOverdueCuotas - totalMoraPaid);

                // Calculate the difference in mora since the last check
                const previousMoraAcumulada = loan.moraAcumulada || 0;
                const moraDifference = newMoraAcumulada - previousMoraAcumulada;

                // Update the loan object's mora and saldo
                loan.moraAcumulada = newMoraAcumulada;
                loan.cuotasEnMora = currentCuotasEnMoraCount;

                // Adjust saldo based on the change in pending mora
                if (Math.abs(moraDifference) > 0.005) { // Only adjust if there's a significant difference
                    loan.saldoPendiente += moraDifference;
                     console.log(`Saldo pendiente de pr√©stamo ID ${loan.id} ajustado por cambio en mora: ${formatNumberRD(moraDifference)}. Nuevo Saldo: ${formatNumberRD(loan.saldoPendiente)}`);
                     if (sesionActiva && moraDifference > 0.005) { // Only show message for newly added mora
                         showMessage(`Mora de RD$${formatNumberRD(moraDifference)} aplicada a ${loan.nombre}. Saldo actualizado.`, 'info', 6000);
                     }
                }


                // Ensure saldoPendiente and moraAcumulada are not negative
                if (loan.saldoPendiente < 0.005 && loan.saldoPendiente > -0.005) loan.saldoPendiente = 0;
                if (loan.moraAcumulada < 0.005 && loan.moraAcumulada > -0.005) loan.moraAcumulada = 0;

            });
            saveLoansToLocalStorage();
        }


        // --- ALMACENAMIENTO Y GESTI√ìN DE DATOS ---
        function saveLoansToLocalStorage() { localStorage.setItem('gestorPrestamosDataPRO', JSON.stringify(loansData)); }

        function loadLoansFromLocalStorage() {
            const dataString = localStorage.getItem('gestorPrestamosDataPRO');
            let parsedData = [];
            if (dataString) {
                try {
                    parsedData = JSON.parse(dataString);
                    if (!Array.isArray(parsedData)) {
                        console.warn("Los datos de localStorage no eran un array. Se resetar√°.");
                        parsedData = [];
                        showMessage("Los datos guardados ten√≠an un formato incorrecto y fueron reseteados.", "warning", 5000);
                    }
                } catch (error) {
                    console.error("Error al parsear datos de localStorage:", error);
                    parsedData = [];
                    showMessage("Hubo un error al cargar los datos guardados (posiblemente corruptos). Se iniciar√° con una lista vac√≠a.", "error", 7000);
                }
            }

            loansData = parsedData;

            loansData.forEach(loan => {
                // Ensure numeric fields are parsed correctly
                loan.moraAcumulada = parseFloat(loan.moraAcumulada) || 0;
                loan.cuotasEnMora = parseInt(loan.cuotasEnMora) || 0;
                // Remove the deprecated fechasCuotasConMora if it exists
                if (loan.hasOwnProperty('fechasCuotasConMora')) {
                    delete loan.fechasCuotasConMora;
                }


                // Re-calculate original total and interest if missing (for compatibility with older data)
                if (!loan.hasOwnProperty('totalPagarOriginal') && loan.hasOwnProperty('totalPagar')) {
                     // Assuming totalPagar from older versions included potential initial mora, remove it for original total
                     loan.totalPagarOriginal = parseFloat(loan.totalPagar) - (loan.moraAcumulada || 0);
                 } else {
                     loan.totalPagarOriginal = parseFloat(loan.totalPagarOriginal) || parseFloat(loan.totalPagar) || 0;
                 }

                 if (!loan.hasOwnProperty('interesTotal') && loan.totalPagarOriginal && loan.importeCredito) {
                    let costoContratoFinanciado = 0;
                    if (loan.llevoContrato === 'Si' && loan.costoContrato && loan.costoContratoPagadoAdelantado === 'No') {
                        costoContratoFinanciado = parseFloat(loan.costoContrato) || 0;
                    }
                    loan.interesTotal = parseFloat(loan.totalPagarOriginal) - (parseFloat(loan.importeCredito) || 0) - costoContratoFinanciado;
                } else {
                    loan.interesTotal = parseFloat(loan.interesTotal) || 0;
                }


                loan.importeCredito = parseFloat(loan.importeCredito) || 0;
                loan.saldoPendiente = parseFloat(loan.saldoPendiente) || 0;
                loan.cuotaPeriodica = parseFloat(loan.cuotaPeriodica) || 0;
                if (loan.costoContrato) loan.costoContrato = parseFloat(loan.costoContrato) || 0;
                else loan.costoContrato = 0;

                // Ensure payments array and its properties are correct
                if(loan.pagos && Array.isArray(loan.pagos)){
                    loan.pagos.forEach(p => {
                        p.montoPagado = parseFloat(p.montoPagado) || 0;
                        // Ensure esPagoSoloInteres and tipoPagoLabel exist
                        if (p.esPagoSoloInteres === undefined) {
                            p.esPagoSoloInteres = (p.tipoPago === 'solo_interes');
                        }
                        if (!p.hasOwnProperty('tipoPagoLabel')) {
                            p.tipoPagoLabel = (p.tipoPago === 'solo_interes' ? 'Solo Inter√©s' : 'Inter√©s y Capital');
                        }
                        // Initialize montoAplicadoAMora if it doesn't exist (for older data)
                        p.montoAplicadoAMora = parseFloat(p.montoAplicadoAMora) || 0;
                    });
                } else {
                    loan.pagos = [];
                }

                // Recalculate saldoPendiente based on original total and payments (excluding mora initially)
                let totalPagadoCapitalInteres = 0;
                 if (loan.pagos && loan.pagos.length > 0) {
                     loan.pagos.filter(p => p.tipoPago === 'interes_capital').forEach(p => {
                         totalPagadoCapitalInteres += (p.montoPagado - (p.montoAplicadoAMora || 0)); // Sum amount applied to P+I
                     });
                 }
                 // Set base saldo from original total minus payments to P+I
                 loan.saldoPendiente = loan.totalPagarOriginal - totalPagadoCapitalInteres;
                 // Add current pending mora to the saldo
                 loan.saldoPendiente += (loan.moraAcumulada || 0);

                 if (loan.saldoPendiente < 0.005 && loan.saldoPendiente > -0.005) loan.saldoPendiente = 0;
                 if (loan.moraAcumulada < 0.005 && loan.moraAcumulada > -0.005) loan.moraAcumulada = 0;

            });
        }


        function saveData() {
            const calculos = calculateLoan();
            if (!calculos || !nombreInput.value.trim()) {
                showMessage(!nombreInput.value.trim() ? 'El nombre del cliente es obligatorio.' : 'Verifique los datos del formulario y calcule el pr√©stamo primero.', 'error');
                if (!nombreInput.value.trim()) nombreInput.focus();
                return;
            }

            const currentEditingId = editingLoanIdInput.value ? parseInt(editingLoanIdInput.value) : null;
            let loan;
            let isNewLoan = false;
            let fechaPrestamoOriginal = null;

            if (currentEditingId) {
                loan = loansData.find(l => l.id === currentEditingId);
                if (!loan) {
                    showMessage('Error: No se encontr√≥ el pr√©stamo que intentaba editar. Se guardar√° como un nuevo pr√©stamo.', 'error');
                    editingLoanIdInput.value = '';
                    // Initialize new loan with necessary properties
                    loan = { id: Date.now(), pagos: [], moraAcumulada: 0, cuotasEnMora: 0 };
                    isNewLoan = true;
                } else {
                    fechaPrestamoOriginal = loan.fechaPrestamo; // Guardar fecha original para comparar
                }
            } else {
                 // Initialize new loan with necessary properties
                loan = { id: Date.now(), pagos: [], moraAcumulada: 0, cuotasEnMora: 0 };
                isNewLoan = true;
            }

            // Asignar todos los valores del formulario al objeto loan
            loan.nombre = nombreInput.value.trim();
            loan.direccion = direccionInput.value.trim();
            loan.telefono = telefonoInput.value.trim();
            loan.email = emailInput.value.trim();
            loan.fechaPrestamo = fechaPrestamoInput.value; // Nueva fecha
            loan.importeCredito = parseFlexibleFloat(importeCreditoInput.value);
            loan.modalidadPago = modalidadPagoSelect.value;
            loan.tasaInteresValor = parseFlexibleFloat(tasaInteresValorInput.value);
            loan.tipoTasa = tipoTasaSelect.value;
            loan.numeroCuotas = parseInt(numeroCuotasInput.value);
            loan.llevoContrato = llevoContratoSelect.value;
            loan.costoContrato = (llevoContratoSelect.value === 'Si' ? parseFlexibleFloat(costoContratoInput.value) : 0);
            loan.costoContratoPagadoAdelantado = (llevoContratoSelect.value === 'Si' ? costoContratoPagadoSelect.value : 'No');
            loan.garantia = garantiaSelect.value;
            loan.detallesGarantia = (garantiaSelect.value === 'Si' ? detallesGarantiaInput.value.trim() : '');

            loan.cuotaPeriodica = calculos.cuotaPeriodica;
            loan.totalPagarOriginal = calculos.totalPagar; // This is the total amount including original interest and financed contract cost
            loan.interesTotal = calculos.interesTotal; // This is the original calculated interest

            // Recalcular saldo pendiente base (sin mora) based on the new totalPagarOriginal
            let totalPagadoCapitalInteres = 0;
            if (loan.pagos && loan.pagos.length > 0) {
                 loan.pagos.filter(p => p.tipoPago === 'interes_capital').forEach(p => {
                     totalPagadoCapitalInteres += (p.montoPagado - (p.montoAplicadoAMora || 0)); // Only sum amount applied to P+I
                 });
            }
            // Set base saldo from original total minus payments to P+I
            loan.saldoPendiente = loan.totalPagarOriginal - totalPagadoCapitalInteres;

            // If the date or number of cuotas changed, reset mora for recalculation
            if (!isNewLoan && (fechaPrestamoOriginal && loan.fechaPrestamo !== fechaPrestamoOriginal || loan.numeroCuotas !== loan._originalNumeroCuotas)) {
                 loan.moraAcumulada = 0;
                 loan.cuotasEnMora = 0;
                 // Add a flag or store original number of cuotas if needed for this check in the future
                 loan._originalNumeroCuotas = loan.numeroCuotas; // Store the number of cuotas at the time of saving
                 showMessage('Fecha o n√∫mero de cuotas modificados. La mora ser√° recalculada.', 'info', 5000);
             } else if (!isNewLoan) {
                // If not a new loan and date/cuotas didn't change, add existing mora to saldo
                loan.saldoPendiente += (loan.moraAcumulada || 0);
             } else {
                 // For a new loan, initialize original number of cuotas
                 loan._originalNumeroCuotas = loan.numeroCuotas;
             }


            if (loan.saldoPendiente < 0.005 && loan.saldoPendiente > -0.005) loan.saldoPendiente = 0;
             if (loan.moraAcumulada < 0.005 && loan.moraAcumulada > -0.005) loan.moraAcumulada = 0;


            if (isNewLoan) {
                loansData.push(loan);
            }

            saveLoansToLocalStorage();
            checkAndApplyMoraToAllLoans(); // This will apply/recalculate mora based on the new state
            updateAdminTable();
            updateGlobalStats();

            showMessage(`Pr√©stamo para ${loan.nombre} ${currentEditingId && !isNewLoan ? 'actualizado' : 'guardado'} correctamente.`, 'success');

            clearForm();
        }

        function downloadClientData(loan) {
            const today = new Date();
            const formattedDate = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            const filename = `Prestamo_${loan.nombre.replace(/\s+/g, '_')}_${formattedDate}.txt`;

            let dataString = `--- Datos del Cliente y Pr√©stamo ---\nID: ${loan.id}\nFecha Registro: ${formattedDate}\nNombre: ${loan.nombre}\nDirecci√≥n: ${loan.direccion || 'N/A'}\nTel√©fono: ${loan.telefono || 'N/A'}\nEmail: ${loan.email || 'N/A'}\n\n--- Detalles del Pr√©stamo ---\nFecha Pr√©stamo: ${loan.fechaPrestamo}\nImporte Cr√©dito: RD$${formatNumberRD(loan.importeCredito)}\nTasa Inter√©s: ${loan.tasaInteresValor}% s/capital\nInter√©s Total Original: RD$${formatNumberRD(loan.interesTotal || 0)}\n`;
            if (loan.llevoContrato === 'Si' && loan.costoContrato > 0.005) {
                dataString += `Costo Contrato: RD$${formatNumberRD(loan.costoContrato)} (${loan.costoContratoPagadoAdelantado === 'Si' ? 'Pagado adelantado' : 'Incluido en financiamiento'})\n`;
            }
            dataString += `Total General Original: RD$${formatNumberRD(loan.totalPagarOriginal || loan.totalPagar)}\n`;
            dataString += `Mora Acumulada (Cargada al Saldo): RD$${formatNumberRD(loan.moraAcumulada || 0)}\n`;
            dataString += `Modalidad Pago: ${loan.modalidadPago}\nCuotas: ${loan.numeroCuotas}\nMonto Cuota: RD$${formatNumberRD(loan.cuotaPeriodica)}\n`;
            if (loan.garantia === 'Si') dataString += `Garant√≠a: S√≠\n  Detalles: ${loan.detallesGarantia || 'N/A'}\n`;
            else dataString += `Garant√≠a: No\n`;

            dataString += `\n--- Pagos --- (${loan.pagos ? loan.pagos.length : 0} realizados)\n`;
            if (loan.pagos && loan.pagos.length > 0) {
                loan.pagos.forEach(p => { dataString += `${p.fechaPago} | RD$${formatNumberRD(p.montoPagado)} | ${p.tipoPagoLabel} | Mora Cubierta: RD$${formatNumberRD(p.montoAplicadoAMora || 0)} | Nota: ${p.notasPago || '-'}\n`; });
            } else {
                dataString += `No hay pagos registrados.\n`;
            }
            dataString += `\nSaldo Pendiente Actual (incluye mora): RD$${formatNumberRD(loan.saldoPendiente)}\n`;
            dataString += `Inter√©s Total Pagado (Contractual + Adicional): RD$${formatNumberRD(calcularInteresGanadoOriginal(loan))}\n`;

            const blob = new Blob([dataString], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }

        function calcularInteresGanadoOriginal(loan) {
            if (!loan || !loan.pagos) return 0;

            let interesContractualPagado = 0;
            let interesSoloPagado = 0;

            // Sum payments applied to principal and interest *after* covering mora
            const totalPagadoHaciaPrincipalEInteres = (loan.pagos || [])
                .filter(p => p.tipoPago === 'interes_capital')
                .reduce((sum, p) => sum + (p.montoPagado - (p.montoAplicadoAMora || 0)), 0);

            const interesOriginalContractual = loan.interesTotal || 0;

            // The amount of the original contractual interest that has been covered by payments
            interesContractualPagado = Math.min(totalPagadoHaciaPrincipalEInteres, interesOriginalContractual);


            // Sum payments specifically marked as 'solo_interes'
            interesSoloPagado = (loan.pagos || [])
                .filter(p => p.esPagoSoloInteres === true || p.tipoPago === 'solo_interes')
                .reduce((sum, p) => sum + p.montoPagado, 0);

             // If the loan is fully paid off, assume all original interest was paid
             if (loan.saldoPendiente <= 0.005) {
                 interesContractualPagado = interesOriginalContractual;
             }


            return Math.max(0, interesContractualPagado + interesSoloPagado);
        }

        function clearForm() {
            loanForm.reset();
            editingLoanIdInput.value = '';
            fechaPrestamoInput.valueAsDate = new Date();
            toggleCostoContrato(); toggleDetallesGarantia(); clearDisplayResults();
            showMessage('Formulario limpiado.', 'info');
        }

        // --- SECCI√ìN DE ADMINISTRACI√ìN ---
        function showAdminSection() {
            function showAdminSection() {
            mainFormContainer.classList.add('hidden');
            adminSection.classList.remove('hidden');
            if (usuarioActual === 'Kamina') {
                adminsPanel.classList.remove('hidden');
                updateAdminsPanel();
            } else {
                adminsPanel.classList.add('hidden');
            }
        }    adminSection.style.display = 'block';
            updateAdminTable();
            updateGlobalStats();
        }

        function showMainForm() {
            adminSection.classList.add('hidden'); adminSection.style.display = 'none';
            mainFormContainer.classList.remove('hidden');
        }

        function updateGlobalStats() {
            let sumTotalCapitalPrestado = 0;
            let sumTotalInteresOriginalPagadoGlobal = 0;
            let sumTotalMoraPagada = 0;
            let clientesEnMoraActivaCount = 0;

            loansData.forEach(loan => {
                sumTotalCapitalPrestado += loan.importeCredito;
                sumTotalInteresOriginalPagadoGlobal += calcularInteresGanadoOriginal(loan);

                // Sum mora paid from each payment's montoAplicadoAMora
                if (loan.pagos && Array.isArray(loan.pagos)) {
                    loan.pagos.forEach(p => {
                        sumTotalMoraPagada += (p.montoAplicadoAMora || 0);
                    });
                }

                if ((loan.cuotasEnMora || 0) > 0 && loan.saldoPendiente > 0.005) {
                    clientesEnMoraActivaCount++;
                }
            });

            const sumTotalGanancia = sumTotalInteresOriginalPagadoGlobal + sumTotalMoraPagada;

            totalCapitalPrestadoDisplay.textContent = `RD$${formatNumberRD(sumTotalCapitalPrestado)}`;
            totalInteresGanadoGlobalDisplay.textContent = `RD$${formatNumberRD(sumTotalInteresOriginalPagadoGlobal)}`;
            totalMoraGanadaGlobalDisplay.textContent = `RD$${formatNumberRD(sumTotalMoraPagada)}`;
            totalGananciaGlobalDisplay.textContent = `RD$${formatNumberRD(sumTotalGanancia)}`;
            clientesEnMoraGlobalDisplay.textContent = clientesEnMoraActivaCount;
        }


        function updateAdminTable() {
            loansTableBody.innerHTML = '';
            const selectedFilterValue = filterLoansSelect.value;
            const clientNameFilterText = filterClientsInput ? filterClientsInput.value.toLowerCase().trim() : '';

            const filteredLoans = loansData.filter(loan => {
                const esPagado = loan.saldoPendiente <= 0.005;

                const matchesClientName = clientNameFilterText === '' || (loan.nombre && loan.nombre.toLowerCase().includes(clientNameFilterText));
                if (!matchesClientName) return false;

                switch (selectedFilterValue) {
                    case "TodosActivos": return !esPagado;
                    case "Todos": return true;
                    case "Pagados": return esPagado;
                    case "Mensual": return loan.modalidadPago === "Mensual" && !esPagado;
                    case "Quincenal": return loan.modalidadPago === "Quincenal" && !esPagado;
                    case "Semanal": return loan.modalidadPago === "Semanal" && !esPagado;
                    default: return true;
                }
            });

            const hasLoans = filteredLoans.length > 0;
            noLoansMessage.classList.toggle('hidden', hasLoans);

            if(hasLoans) {
                filteredLoans.forEach((loan) => {
                    let garantiaDisplay = '-';
                    if (loan.garantia === 'Si') {
                        garantiaDisplay = (loan.detallesGarantia && loan.detallesGarantia.trim() !== '') ?
                            (loan.detallesGarantia.length > 20 ?
                                `<span class="truncate-tooltip">${loan.detallesGarantia.substring(0, 17)}...<span class="tooltiptext-cell">${loan.detallesGarantia}</span></span>` :
                                loan.detallesGarantia) :
                            'S√≠';
                    }

                    const interesPagadoCliente = calcularInteresGanadoOriginal(loan);
                    const moraAcumuladaCliente = loan.moraAcumulada || 0;

                    const row = loansTableBody.insertRow();

                    let rowClass = 'hover:bg-gray-50 transition-colors duration-150';
                    if (loan.saldoPendiente <= 0.005) {
                        rowClass = 'bg-green-50 hover:bg-green-100 transition-colors duration-150';
                    } else if ((loan.cuotasEnMora || 0) > 0) {
                        rowClass = 'bg-red-50 hover:bg-red-100 transition-colors duration-150';
                    }
                    row.className = rowClass;

                    let actionsHtml = `
                        <button onclick="openPaymentModal(${loan.id})" class="p-1.5 bg-green-100 text-green-700 rounded hover:bg-green-200 text-xs" title="Registrar Pago">üí∞</button>
                        <button onclick="viewPayments(${loan.id})" class="p-1.5 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-xs" title="Ver Pagos">üìÑ</button>
                        <button onclick="editLoan(${loan.id})" class="p-1.5 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 text-xs" title="Editar Pr√©stamo">‚úèÔ∏è</button>
                        <button onclick="deleteLoan(${loan.id})" class="p-1.5 bg-red-100 text-red-700 rounded hover:bg-red-200 text-xs" title="Eliminar Pr√©stamo">üóëÔ∏è</button>
                        <button onclick="regenerateTxtFile(${loan.id})" class="p-1.5 bg-purple-100 text-purple-700 rounded hover:bg-purple-200 text-xs" title="Descargar TXT Individual">TXT</button>
                        <button onclick="printLoanDetails(${loan.id})" class="p-1.5 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 text-xs" title="Imprimir Pr√©stamo">üñ®Ô∏è</button>
                    `;

                    if (loan.saldoPendiente <= 0.005) { // Si el pr√©stamo est√° pagado
                        actionsHtml += `<button onclick="reutilizarCliente(${loan.id})" class="p-1.5 bg-teal-100 text-teal-700 rounded hover:bg-teal-200 text-xs" title="Reutilizar Cliente para Nuevo Pr√©stamo">üîÑ</button>`;
                    }


                    row.innerHTML = `
                        <td class="px-6 py-3">${loan.nombre}</td>
                        <td class="px-6 py-3">RD$${formatNumberRD(loan.importeCredito)}</td>
                        <td class="px-6 py-3">${loan.tasaInteresValor}%</td>
                        <td class="px-6 py-3">RD$${formatNumberRD(loan.cuotaPeriodica)}</td>
                        <td class="px-6 py-3 text-green-700">RD$${formatNumberRD(interesPagadoCliente)}</td>
                        <td class="px-6 py-3 text-orange-600">RD$${formatNumberRD(moraAcumuladaCliente)}</td>
                        <td class="px-6 py-3 font-semibold ${loan.saldoPendiente > 0.005 ? 'text-red-600' : 'text-green-600'}">RD$${formatNumberRD(loan.saldoPendiente)}</td>
                        <td class="px-6 py-3">${garantiaDisplay}</td>
                        <td class="px-6 py-3 space-x-1 whitespace-nowrap">${actionsHtml}</td>`;
                });
            }
        }

        function reutilizarCliente(loanId) {
            const loan = loansData.find(l => l.id === loanId);
            if (loan) {
                clearForm(); // Limpia todo el formulario primero
                nombreInput.value = loan.nombre;
                direccionInput.value = loan.direccion || '';
                telefonoInput.value = loan.telefono || '';
                emailInput.value = loan.email || '';

                // Asegurarse que no estamos editando el pr√©stamo antiguo
                editingLoanIdInput.value = '';

                showMainForm();
                // Opcional: enfocar un campo relevante para el nuevo pr√©stamo, como el importe
                importeCreditoInput.focus();
                showMessage(`Datos de ${loan.nombre} cargados. Ingrese los detalles del nuevo pr√©stamo.`, 'info', 5000);
            } else {
                showMessage('Error: No se pudo encontrar el cliente para reutilizar.', 'error');
            }
        }


        function regenerateTxtFile(loanId) {
            const loan = loansData.find(l => l.id === loanId);
            if (loan) downloadClientData(loan);
            else showMessage('Error: Pr√©stamo no encontrado para generar TXT.', 'error');
        }

        function editLoan(loanId) {
            const loan = loansData.find(l => l.id === loanId);
            if (!loan) { showMessage('Error al cargar datos para edici√≥n. Pr√©stamo no encontrado.', 'error'); return; }

            editingLoanIdInput.value = loan.id;

            nombreInput.value = loan.nombre;
            direccionInput.value = loan.direccion || '';
            telefonoInput.value = loan.telefono || '';
            emailInput.value = loan.email || '';
            fechaPrestamoInput.value = loan.fechaPrestamo;
            importeCreditoInput.value = formatNumberRD(loan.importeCredito, 2, 2);
            modalidadPagoSelect.value = loan.modalidadPago;
            tasaInteresValorInput.value = formatNumberRD(loan.tasaInteresValor, 2, 2);
            tipoTasaSelect.value = loan.tipoTasa;
            numeroCuotasInput.value = loan.numeroCuotas;
            llevoContratoSelect.value = loan.llevoContrato;
            costoContratoInput.value = loan.costoContrato > 0.005 ? formatNumberRD(loan.costoContrato, 2, 2) : '';
            costoContratoPagadoSelect.value = loan.costoContratoPagadoAdelantado || 'No';
            garantiaSelect.value = loan.garantia;
            detallesGarantiaInput.value = loan.detallesGarantia || '';

            toggleCostoContrato();
            toggleDetallesGarantia();

            cuotaPeriodicaDisplay.textContent = `RD$${formatNumberRD(loan.cuotaPeriodica)}`;
            totalPagarDisplay.textContent = `RD$${formatNumberRD(loan.totalPagarOriginal || loan.totalPagar)}`;
            interesTotalDisplay.textContent = `RD$${formatNumberRD(loan.interesTotal || 0)}`;

            showMessage(`"${loan.nombre}" cargado para edici√≥n.`, 'info', 5000);

            showMainForm();
            nombreInput.focus();
        }

        function deleteLoan(loanId) {
            const loanIndex = loansData.findIndex(loan => loan.id === loanId);
            if (loanIndex > -1) {
                if (confirm(`¬øEst√° seguro de que desea eliminar el pr√©stamo de ${loansData[loanIndex].nombre}? Esta acci√≥n no se puede deshacer.`)) {
                    const name = loansData[loanIndex].nombre;
                    loansData.splice(loanIndex, 1);
                    saveLoansToLocalStorage();
                    updateAdminTable(); updateGlobalStats();
                    showMessage(`Pr√©stamo de ${name} eliminado correctamente.`, 'success');
                }
            } else showMessage('Error: Pr√©stamo no encontrado para eliminar.', 'error');
        }

        // --- MODAL DE LOGIN ---
        adminAccessBtn.addEventListener('click', () => {
            if (sesionActiva) {
                showAdminSection();
            } else {
                loginModal.style.display = 'flex';
                usernameInput.value = '';
                passwordInput.value = '';
                usernameInput.focus();
            }
        });

        cancelLoginBtn.addEventListener('click', () => { loginModal.style.display = 'none'; });

        loginFormElement.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const res = await fetch('http://localhost:3001/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ username: usernameInput.value, password: passwordInput.value })
                });
                const data = await res.json();
                if (data.success) {
                    sesionActiva = true;
                    usuarioActual = data.username;
                    loginModal.style.display = 'none';
                    showAdminSection();
                    showMessage('Acceso concedido. Bienvenido a la administraci√≥n.', 'success');
                    updateAdminsPanel();
                } else {
                    showMessage(data.error || 'Usuario o contrase√±a incorrectos. Intente de nuevo.', 'error');
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            } catch (err) {
                showMessage('Error de conexi√≥n con el servidor.', 'error');
            }
        });

        backToFormBtn.addEventListener('click', showMainForm);

        // --- PANEL DE ADMINISTRADORES (solo Kamina) ---
        const adminsPanel = document.getElementById('adminsPanel');
        const addAdminForm = document.getElementById('addAdminForm');
        const newAdminUser = document.getElementById('newAdminUser');
        const newAdminPass = document.getElementById('newAdminPass');
        const adminsList = document.getElementById('adminsList');

        async function updateAdminsPanel() {
            if (usuarioActual !== 'Kamina') return;
            try {
                const res = await fetch('http://localhost:3001/api/admins', { credentials: 'include' });
                const users = await res.json();
                adminsList.innerHTML = '';
                users.forEach(user => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center gap-3';
                    li.textContent = user;
                    if (user !== 'Kamina') {
                        const delBtn = document.createElement('button');
                        delBtn.textContent = 'Eliminar';
                        delBtn.className = 'ml-4 px-2 py-1 bg-red-500 text-white rounded-md text-xs';
                        delBtn.onclick = async () => {
                            if (confirm('¬øSeguro que deseas eliminar el admin ' + user + '?')) {
                                await fetch('http://localhost:3001/api/admins/' + encodeURIComponent(user), {
                                    method: 'DELETE', credentials: 'include'
                                });
                                updateAdminsPanel();
                            }
                        };
                        li.appendChild(delBtn);
                    }
                    adminsList.appendChild(li);
                });
            } catch (err) {
                adminsList.innerHTML = '<li class="text-red-500">Error al cargar admins</li>';
            }
        }

        if (addAdminForm) {
            addAdminForm.onsubmit = async (e) => {
                e.preventDefault();
                if (!newAdminUser.value.trim() || !newAdminPass.value.trim()) return;
                try {
                    const res = await fetch('http://localhost:3001/api/admins', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ username: newAdminUser.value, password: newAdminPass.value })
                    });
                    const data = await res.json();
                    if (data.success) {
                        showMessage('Administrador agregado.', 'success');
                        newAdminUser.value = '';
                        newAdminPass.value = '';
                        updateAdminsPanel();
                    } else {
                        showMessage(data.error || 'No se pudo agregar admin.', 'error');
                    }
                } catch (err) {
                    showMessage('Error de conexi√≥n con el servidor.', 'error');
                }
            };
        }

        // Al cargar, preguntar si hay sesi√≥n activa
        fetch('http://localhost:3001/api/whoami', { credentials: 'include' })
            .then(r => r.json())
            .then(data => { if (data.user) { sesionActiva = true; usuarioActual = data.user; } });

        // --- MODAL DE PAGO ---
        function openPaymentModal(loanId) {
            const loan = loansData.find(l => l.id === loanId);
            if (loan) {
                currentEditingPaymentInfo = { loanId: null, pagoIndex: -1 };

                paymentLoanIdInput.value = loan.id;
                paymentModalLoanClient.textContent = loan.nombre;
                fechaPagoInputModal.valueAsDate = new Date();
                montoPagadoInputModal.value = '';
                tipoPagoSelectModal.value = 'interes_capital';
                notasPagoInputModal.value = '';
                montoPagadoInputModal.placeholder = `Cuota: ${formatNumberRD(loan.cuotaPeriodica)}. Saldo: ${formatNumberRD(loan.saldoPendiente)}`;
                paymentModal.style.display = 'flex';
            } else showMessage('Error: Pr√©stamo no encontrado para registrar pago.', 'error');
        }

        cancelPaymentBtn.addEventListener('click', () => {
            paymentModal.style.display = 'none';
            currentEditingPaymentInfo = { loanId: null, pagoIndex: -1 };
        });

        paymentFormElement.addEventListener('submit', (e) => {
            e.preventDefault();
            const loanIdFromInput = parseInt(paymentLoanIdInput.value);
            const montoPagadoVal = parseFlexibleFloat(montoPagadoInputModal.value);
            const tipoPagoSeleccionado = tipoPagoSelectModal.value;
            const fechaPagoSeleccionada = fechaPagoInputModal.value;
            const notasDelPago = notasPagoInputModal.value.trim();

            if (isNaN(montoPagadoVal) || montoPagadoVal <= 0) { showMessage('El monto pagado debe ser un n√∫mero positivo.', 'error'); montoPagadoInputModal.focus(); return; }
            if (!fechaPagoSeleccionada) { showMessage('La fecha de pago es obligatoria.', 'error'); fechaPagoInputModal.focus(); return; }

            let loan = loansData.find(l => l.id === loanIdFromInput);
            if (!loan) { showMessage('Error: Pr√©stamo no encontrado al procesar el pago.', 'error'); return; }

            // --- Revert effect of original payment if editing ---
            if (currentEditingPaymentInfo.pagoIndex !== -1 && currentEditingPaymentInfo.loanId === loanIdFromInput) {
                const pagoOriginal = loan.pagos[currentEditingPaymentInfo.pagoIndex];
                 if (pagoOriginal) {
                    // Revert the financial impact of the original payment
                    loan.saldoPendiente += pagoOriginal.montoPagado; // Add back the total amount
                    loan.moraAcumulada += (pagoOriginal.montoAplicadoAMora || 0); // Add back amount that covered mora
                    console.log(`Revertido pago original (ID ${loan.id}, index ${currentEditingPaymentInfo.pagoIndex}): Saldo +${formatNumberRD(pagoOriginal.montoPagado)}, Mora +${formatNumberRD(pagoOriginal.montoAplicadoAMora || 0)}`);

                    // Remove the original payment from the array
                    loan.pagos.splice(currentEditingPaymentInfo.pagoIndex, 1);
                 } else {
                     console.error(`Error: Pago original (index ${currentEditingPaymentInfo.pagoIndex}) no encontrado para edici√≥n en pr√©stamo ID ${loan.id}.`);
                 }
            }

            // --- Apply the new/edited payment ---
            const nuevoPago = {
                fechaPago: fechaPagoSeleccionada,
                montoPagado: montoPagadoVal,
                tipoPago: tipoPagoSeleccionado,
                tipoPagoLabel: tipoPagoSelectModal.options[tipoPagoSelectModal.selectedIndex].text,
                notasPago: notasDelPago,
                esPagoSoloInteres: tipoPagoSeleccionado === 'solo_interes',
                montoAplicadoAMora: 0 // Initialize for the new/edited payment
            };

            if (!loan.pagos) loan.pagos = [];

            let montoRestanteDelPago = nuevoPago.montoPagado;

            if (nuevoPago.tipoPago === 'interes_capital') {
                // Prioritize covering pending mora first
                let moraPendienteActual = loan.moraAcumulada || 0;
                if (moraPendienteActual > 0.005) {
                    const amountToApplyToMora = Math.min(montoRestanteDelPago, moraPendienteActual);
                    nuevoPago.montoAplicadoAMora = amountToApplyToMora; // Record how much mora this payment covers
                    loan.moraAcumulada -= amountToApplyToMora; // Reduce pending mora amount
                    loan.saldoPendiente -= amountToApplyToMora; // Reduce saldo by the mora amount paid
                    montoRestanteDelPago -= amountToApplyToMora; // Reduce remaining payment amount
                     console.log(`Pago ID ${loan.id}: Aplicado RD$${formatNumberRD(amountToApplyToMora)} a mora. Mora restante: RD$${formatNumberRD(loan.moraAcumulada)}`);
                }

                // Apply the rest of the payment to principal and interest
                 if (montoRestanteDelPago > 0.005) {
                     loan.saldoPendiente -= montoRestanteDelPago; // Reduce saldo by the amount applied to principal/interest
                     console.log(`Pago ID ${loan.id}: Aplicado RD$${formatNumberRD(montoRestanteDelPago)} a capital/inter√©s. Saldo restante: RD$${formatNumberRD(loan.saldoPendiente)}`);
                 }
            } else if (nuevoPago.tipoPago === 'solo_interes') {
                // 'Solo Inter√©s' payments do not reduce saldoPendiente or moraAcumulada.
                // They are just recorded as income.
                 console.log(`Pago ID ${loan.id}: Pago de Solo Inter√©s RD$${formatNumberRD(nuevoPago.montoPagado)}. No afecta saldo ni mora.`);
            }


            // Add the new/edited payment to the array.
            loan.pagos.push(nuevoPago);


            // Ensure saldoPendiente and moraAcumulada are not negative (due to floating point math or overpayment)
            if (loan.saldoPendiente < 0.005 && loan.saldoPendiente > -0.005) loan.saldoPendiente = 0;
             if (loan.moraAcumulada < 0.005 && loan.moraAcumulada > -0.005) loan.moraAcumulada = 0;


            // If the loan is now paid off, reset mora and related flags
            if (loan.saldoPendiente <= 0.005) {
                loan.moraAcumulada = 0;
                loan.cuotasEnMora = 0;
                 console.log(`Pr√©stamo ID ${loan.id} pagado. Mora y cuotas en mora reseteadas.`);
            }


            currentEditingPaymentInfo = { loanId: null, pagoIndex: -1 }; // Reset editing state

            saveLoansToLocalStorage();
            checkAndApplyMoraToAllLoans(); // Re-run mora check based on updated state
            updateAdminTable();
            updateGlobalStats();
            paymentModal.style.display = 'none';
            showMessage(`Pago (${nuevoPago.tipoPagoLabel}) de RD$${formatNumberRD(nuevoPago.montoPagado)} registrado/actualizado para ${loan.nombre}.`, 'success');
        });


        // --- MODAL PARA VER PAGOS ---
        function viewPayments(loanId) {
            const loan = loansData.find(l => l.id === loanId);
            if (loan) {
                viewPaymentsModalClientName.textContent = loan.nombre;
                paymentsHistoryContainer.innerHTML = '';

                if (loan.pagos && loan.pagos.length > 0) {
                    const table = document.createElement('table');
                    table.className = 'min-w-full divide-y divide-gray-200 text-sm';
                    const thead = table.createTHead(); thead.className = 'bg-gray-50';
                    const hr = thead.insertRow();
                    // Added "Mora Cubierta" column
                    ['Fecha', 'Monto Pagado', 'Tipo', 'Mora Cubierta', 'Notas', 'Acciones'].forEach(txt => {
                        const th = document.createElement('th');
                        th.className='px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                        th.textContent = txt; hr.appendChild(th);
                    });
                    const tbody = table.createTBody(); tbody.className = 'bg-white divide-y divide-gray-200';

                    loan.pagos.forEach((p, pagoIndex) => {
                        const row = tbody.insertRow();
                        row.insertCell().textContent = p.fechaPago;
                        row.insertCell().textContent = formatNumberRD(p.montoPagado);
                        row.insertCell().textContent = p.tipoPagoLabel;
                        row.insertCell().textContent = formatNumberRD(p.montoAplicadoAMora || 0); // Display mora covered by this payment
                        row.insertCell().textContent = p.notasPago || '-';

                        const accionesCell = row.insertCell();
                        const editarBtn = document.createElement('button');
                        editarBtn.textContent = '‚úèÔ∏è';
                        editarBtn.className = 'text-blue-600 hover:text-blue-800 mr-2 px-1 py-0.5 rounded hover:bg-blue-100';
                        editarBtn.title = 'Editar Pago';
                        editarBtn.onclick = () => editarPago(loan.id, pagoIndex);

                        const eliminarBtn = document.createElement('button');
                        eliminarBtn.textContent = 'üóëÔ∏è';
                        eliminarBtn.className = 'text-red-600 hover:text-red-800 px-1 py-0.5 rounded hover:bg-red-100';
                        eliminarBtn.title = 'Eliminar Pago';
                        eliminarBtn.onclick = () => eliminarPago(loan.id, pagoIndex);

                        accionesCell.appendChild(editarBtn);
                        accionesCell.appendChild(eliminarBtn);
                    });
                    paymentsHistoryContainer.appendChild(table);
                } else paymentsHistoryContainer.innerHTML = '<p class="text-gray-500 text-center">No hay pagos registrados para este pr√©stamo.</p>';

                viewPaymentsModal.style.display = 'flex';
            } else showMessage('Error: Pr√©stamo no encontrado para ver pagos.', 'error');
        }

        closeViewPaymentsModalBtn.addEventListener('click', () => { viewPaymentsModal.style.display = 'none'; });

        function eliminarPago(loanId, pagoIndex) {
            const loan = loansData.find(l => l.id === loanId);
            if (!loan || !loan.pagos || !loan.pagos[pagoIndex]) {
                showMessage('Pago no encontrado para eliminar.', 'error'); return;
            }
            const pagoEliminado = loan.pagos[pagoIndex];

            if (!confirm(`¬øEst√° seguro de que desea eliminar este pago de RD$${formatNumberRD(pagoEliminado.montoPagado)} (${pagoEliminado.tipoPagoLabel}) del pr√©stamo de ${loan.nombre}? Esta acci√≥n no se puede deshacer y afectar√° el saldo pendiente y la mora acumulada.`)) return;

            // Revertir el efecto del pago en el saldo y la mora
            loan.saldoPendiente += pagoEliminado.montoPagado; // Add back the total amount
            loan.moraAcumulada += (pagoEliminado.montoAplicadoAMora || 0); // Add back amount that covered mora
            console.log(`Eliminado pago (ID ${loan.id}, index ${pagoIndex}): Saldo +${formatNumberRD(pagoEliminado.montoPagado)}, Mora +${formatNumberRD(pagoEliminado.montoAplicadoAMora || 0)}`);


            loan.pagos.splice(pagoIndex, 1);

            // Ensure saldoPendiente and moraAcumulada are not negative after adding back
            if (loan.saldoPendiente < 0.005 && loan.saldoPendiente > -0.005) loan.saldoPendiente = 0;
             if (loan.moraAcumulada < 0.005 && loan.moraAcumulada > -0.005) loan.moraAcumulada = 0;


            // If the loan is now paid off after removing a payment, reset mora and related flags
            if (loan.saldoPendiente <= 0.005) {
                loan.moraAcumulada = 0;
                loan.cuotasEnMora = 0;
                 console.log(`Pr√©stamo ID ${loan.id} pagado despu√©s de eliminar pago. Mora y cuotas en mora reseteadas.`);
            }


            saveLoansToLocalStorage();
            checkAndApplyMoraToAllLoans(); // Recalculate mora status based on remaining payments
            updateAdminTable();
            updateGlobalStats();
            showMessage('Pago eliminado correctamente. El saldo y las estad√≠sticas han sido recalculados.', 'success');
            viewPayments(loanId); // Refresh the payments view
        }

        function editarPago(loanId, pagoIndex) {
            const loan = loansData.find(l => l.id === loanId);
            const pago = loan?.pagos?.[pagoIndex];
            if (!loan || !pago) {
                showMessage('Pago no encontrado para editar.', 'error'); return;
            }

            // Store info for the payment being edited
            currentEditingPaymentInfo = { loanId: loanId, pagoIndex: pagoIndex };

            // Pre-fill the payment modal
            paymentLoanIdInput.value = loanId;
            paymentModalLoanClient.textContent = loan.nombre;
            fechaPagoInputModal.value = pago.fechaPago;
            montoPagadoInputModal.value = formatNumberRD(pago.montoPagado, 2,2);
            tipoPagoSelectModal.value = pago.tipoPago;
            notasPagoInputModal.value = pago.notasPago || '';

            viewPaymentsModal.style.display = 'none';
            paymentModal.style.display = 'flex';
            showMessage('Editando pago. Modifique los datos y guarde. El pago original ser√° reemplazado.', 'info');
        }


        // --- EXPORTAR/IMPORTAR DATOS ---
        function exportAllData() {
            if (loansData.length === 0) {
                showMessage('No hay datos para exportar. Registre algunos pr√©stamos primero.', 'info'); return;
            }
            const jsonData = JSON.stringify(loansData, null, 2);
            const blob = new Blob([jsonData], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url;
            a.download = `respaldo_prestamos_gestorPRO_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a); a.click();
            document.body.removeChild(a); URL.revokeObjectURL(url);
            showMessage('Respaldo JSON generado. Su navegador deber√≠a iniciar la descarga o preguntarle d√≥nde guardarlo.', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm('¬øEst√° seguro de que desea importar datos desde este archivo? Esto reemplazar√° todos los datos actuales guardados en el navegador.')) {
                event.target.value = null; return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        loansData = importedData;
                        // Ensure all necessary fields are present and correctly typed after import
                        loansData.forEach(loan => {
                            loan.moraAcumulada = parseFloat(loan.moraAcumulada) || 0;
                            loan.cuotasEnMora = parseInt(loan.cuotasEnMora) || 0;
                            // Remove the deprecated fechasCuotasConMora if it exists
                             if (loan.hasOwnProperty('fechasCuotasConMora')) {
                                 delete loan.fechasCuotasConMora;
                             }

                            loan.importeCredito = parseFloat(loan.importeCredito) || 0;
                            loan.interesTotal = parseFloat(loan.interesTotal) || 0;
                            loan.totalPagarOriginal = parseFloat(loan.totalPagarOriginal) || 0;
                            loan.saldoPendiente = parseFloat(loan.saldoPendiente) || 0;
                            loan.cuotaPeriodica = parseFloat(loan.cuotaPeriodica) || 0;
                            if (loan.costoContrato) loan.costoContrato = parseFloat(loan.costoContrato) || 0;
                            else loan.costoContrato = 0;

                             if(loan.pagos && Array.isArray(loan.pagos)){
                                 loan.pagos.forEach(p => {
                                     p.montoPagado = parseFloat(p.montoPagado) || 0;
                                     if (p.esPagoSoloInteres === undefined) {
                                         p.esPagoSoloInteres = (p.tipoPago === 'solo_interes');
                                     }
                                      if (!p.hasOwnProperty('tipoPagoLabel')) {
                                        p.tipoPagoLabel = (p.tipoPago === 'solo_interes' ? 'Solo Inter√©s' : 'Inter√©s y Capital');
                                    }
                                    p.montoAplicadoAMora = parseFloat(p.montoAplicadoAMora) || 0; // Ensure this exists
                                 });
                             } else {
                                 loan.pagos = [];
                             }
                             // Initialize _originalNumeroCuotas if missing
                             if (!loan.hasOwnProperty('_originalNumeroCuotas')) {
                                 loan._originalNumeroCuotas = loan.numeroCuotas;
                             }
                        });
                        saveLoansToLocalStorage(); // Save the cleaned/updated data structure
                        checkAndApplyMoraToAllLoans(); // Re-calculate mora based on imported data
                        updateAdminTable();
                        updateGlobalStats();
                        showMessage('Datos importados exitosamente desde el archivo JSON.', 'success');
                    } else {
                        showMessage('Error: El archivo seleccionado no contiene un formato de datos v√°lido (debe ser un array de pr√©stamos).', 'error');
                    }
                } catch (err) {
                    showMessage(`Error al importar datos del archivo: ${err.message}`, 'error');
                } finally {
                    event.target.value = null;
                }
            };
            reader.readAsText(file);
        }

        // --- FUNCIONALIDAD DE IMPRESI√ìN (PR√âSTAMO INDIVIDUAL Y REPORTES GLOBALES) ---
        function printLoanDetails(loanId) {
            const loan = loansData.find(l => l.id === loanId);
            if (!loan) { showMessage('Pr√©stamo no encontrado para imprimir.', 'error'); return; }

            let printContent = `<div style="font-family: Arial, sans-serif; font-size: 12px;">`;
            printContent += `<h1 style="text-align:center; color:#333; border-bottom:1px solid #ccc; padding-bottom:5px;">Detalles del Pr√©stamo</h1>`;
            printContent += `<p style="text-align:right; font-size:10px;">ID Pr√©stamo: ${loan.id} | Fecha Impresi√≥n: ${new Date().toLocaleDateString()}</p>`;
            printContent += `<h2 style="color:#555;">Cliente: ${loan.nombre}</h2>`;
            if(loan.telefono) printContent += `<p><strong>Tel√©fono:</strong> ${loan.telefono}</p>`;
            if(loan.direccion) printContent += `<p><strong>Direcci√≥n:</strong> ${loan.direccion}</p>`;

            printContent += `<h3 style="margin-top:15px; border-top:1px dashed #eee; padding-top:10px; color:#555;">Informaci√≥n del Pr√©stamo</h3>`;
            printContent += `<p><strong>Fecha Pr√©stamo:</strong> ${loan.fechaPrestamo}</p>`;
            printContent += `<p><strong>Importe Cr√©dito Original:</strong> RD$${formatNumberRD(loan.importeCredito)}</p>`;
            printContent += `<p><strong>Tasa Inter√©s:</strong> ${loan.tasaInteresValor}% (sobre capital)</p>`;
            printContent += `<p><strong>Inter√©s Total Original Estimado:</strong> RD$${formatNumberRD(loan.interesTotal || 0)}</p>`;
            if (loan.llevoContrato === 'Si' && loan.costoContrato > 0.005) {
                printContent += `<p><strong>Costo Contrato:</strong> RD$${formatNumberRD(loan.costoContrato)} (${loan.costoContratoPagadoAdelantado === 'Si' ? 'Pagado por adelantado' : 'Incluido en financiamiento'})</p>`;
            }
            printContent += `<p><strong>Total General Original (Capital + Inter√©s + Costo Financiado):</strong> RD$${formatNumberRD(loan.totalPagarOriginal || loan.totalPagar)}</p>`;
            printContent += `<p><strong>Mora Acumulada (Cargada al Saldo):</strong> RD$${formatNumberRD(loan.moraAcumulada || 0)}</p>`;
            printContent += `<p><strong>Modalidad Pago:</strong> ${loan.modalidadPago}</p>`;
            printContent += `<p><strong>N√∫mero de Cuotas Original:</strong> ${loan.numeroCuotas}</p>`;
            printContent += `<p><strong>Monto Cuota Estimada (Original):</strong> RD$${formatNumberRD(loan.cuotaPeriodica)}</p>`;
            printContent += `<p style="font-weight:bold; font-size:1.1em; color:${loan.saldoPendiente > 0.005 ? '#D32F2F' : '#388E3C'};">Saldo Pendiente Actual (incluye mora): RD$${formatNumberRD(loan.saldoPendiente)}</p>`;
            if (loan.garantia === 'Si') {
                printContent += `<p><strong>Garant√≠a:</strong> S√≠ (${loan.detallesGarantia || 'Detalles no especificados'})</p>`;
            } else {
                printContent += `<p><strong>Garant√≠a:</strong> No</p>`;
            }

            if (loan.pagos && loan.pagos.length > 0) {
                printContent += `<h3 style="margin-top:15px; border-top:1px dashed #eee; padding-top:10px; color:#555;">Historial de Pagos Registrados</h3>`;
                printContent += `<table border="1" style="width:100%; border-collapse:collapse; font-size:10px;"><thead><tr><th>Fecha</th><th>Monto Pagado (RD$)</th><th>Tipo de Pago</th><th>Mora Cubierta (RD$)</th><th>Notas</th></tr></thead><tbody>`;
                loan.pagos.forEach(p => {
                    printContent += `<tr>
                        <td style="padding:3px;">${p.fechaPago}</td>
                        <td style="padding:3px;">${formatNumberRD(p.montoPagado)}</td>
                        <td style="padding:3px;">${p.tipoPagoLabel}</td>
                        <td style="padding:3px;">${formatNumberRD(p.montoAplicadoAMora || 0)}</td>
                        <td style="padding:3px;">${p.notasPago || '-'}</td>
                    </tr>`;
                });
                printContent += `</tbody></table>`;
            } else {
                printContent += `<p><strong>No hay pagos registrados para este pr√©stamo.</strong></p>`;
            }
            printContent += `</div>`;

            printArea.innerHTML = printContent;
            printArea.classList.remove('hidden');
            window.print();
            printArea.classList.add('hidden');
            printArea.innerHTML = '';
        }

        // --- L√ìGICA DEL MODAL DE OPCIONES DE IMPRESI√ìN GLOBAL ---
        function openGlobalPrintOptionsModal() {
            selectClientForReceipt.innerHTML = '<option value="">-- Seleccione un Cliente --</option>';
            loansData.forEach(loan => {
                const option = document.createElement('option');
                option.value = loan.id;
                option.textContent = `${loan.nombre} (Saldo Actual: RD$${formatNumberRD(loan.saldoPendiente)})`;
                selectClientForReceipt.appendChild(option);
            });
            globalPrintOptionsModal.style.display = 'flex';
        }

        function handlePrintActiveLoans() {
            const activeLoans = loansData.filter(l => l.saldoPendiente > 0.005);
            if (activeLoans.length === 0) {
                showMessage('No hay pr√©stamos activos (pendientes de pago) para imprimir.', 'info'); return;
            }
            let content = `<div style="font-family: Arial, sans-serif; font-size: 12px;">`;
            content += `<h1>Reporte de Pr√©stamos Activos (Pendientes) - ${new Date().toLocaleDateString()}</h1>`;
            content += printMultipleLoansTable(activeLoans);
            content += `</div>`;
            printArea.innerHTML = content;
            printArea.classList.remove('hidden'); window.print(); printArea.classList.add('hidden'); printArea.innerHTML = '';
            globalPrintOptionsModal.style.display = 'none';
        }

        function handlePrintInactiveLoans() {
            const inactiveLoans = loansData.filter(l => l.saldoPendiente <= 0.005);
             if (inactiveLoans.length === 0) {
                showMessage('No hay pr√©stamos inactivos (pagados) para imprimir.', 'info'); return;
            }
            let content = `<div style="font-family: Arial, sans-serif; font-size: 12px;">`;
            content += `<h1>Reporte de Pr√©stamos Inactivos (Pagados) - ${new Date().toLocaleDateString()}</h1>`;
            content += printMultipleLoansTable(inactiveLoans);
            content += `</div>`;
            printArea.innerHTML = content;
            printArea.classList.remove('hidden'); window.print(); printArea.classList.add('hidden'); printArea.innerHTML = '';
            globalPrintOptionsModal.style.display = 'none';
        }

        function printMultipleLoansTable(loansToPrint) {
            let tableHtml = `<table border="1" style="width:100%; border-collapse:collapse; font-size:10px;">
                <thead>
                    <tr style="background-color:#f0f0f0;">
                        <th style="padding:4px;">ID</th><th style="padding:4px;">Cliente</th><th style="padding:4px;">Fecha Pr√©st.</th>
                        <th style="padding:4px;">Monto Orig. (RD$)</th><th style="padding:4px;">Modalidad</th>
                        <th style="padding:4px;">Cuota (RD$)</th><th style="padding:4px;">Total Pagado (RD$)</th>
                        <th style="padding:4px;">Int. Orig. Pag. (RD$)</th><th style="padding:4px;">Mora Carg. (RD$)</th>
                        <th style="padding:4px;">Saldo Pend. (RD$)</th>
                    </tr>
                </thead>
                <tbody>`;
            loansToPrint.forEach(loan => {
                const totalPagadoCliente = (loan.pagos || []).reduce((sum, p) => sum + p.montoPagado, 0);
                const interesOriginalPagado = calcularInteresGanadoOriginal(loan);
                tableHtml += `<tr>
                    <td style="padding:3px;">${loan.id}</td>
                    <td style="padding:3px;">${loan.nombre}</td>
                    <td style="padding:3px;">${loan.fechaPrestamo}</td>
                    <td style="padding:3px; text-align:right;">${formatNumberRD(loan.importeCredito)}</td>
                    <td style="padding:3px;">${loan.modalidadPago}</td>
                    <td style="padding:3px; text-align:right;">${formatNumberRD(loan.cuotaPeriodica)}</td>
                    <td style="padding:3px; text-align:right;">${formatNumberRD(totalPagadoCliente)}</td>
                    <td style="padding:3px; text-align:right;">${formatNumberRD(interesOriginalPagado)}</td>
                    <td style="padding:3px; text-align:right;">${formatNumberRD(loan.moraAcumulada || 0)}</td>
                    <td style="padding:3px; text-align:right; font-weight:bold; color:${loan.saldoPendiente > 0.005 ? 'red' : 'green'};">${formatNumberRD(loan.saldoPendiente)}</td>
                </tr>`;
            });
            tableHtml += `</tbody></table>`;
            return tableHtml;
        }

        function handlePrintSelectedClientReceipt() {
            const selectedLoanId = parseInt(selectClientForReceipt.value);
            if (!selectedLoanId) {
                showMessage('Por favor, seleccione un cliente de la lista para generar el recibo.', 'error'); return;
            }
            const loan = loansData.find(l => l.id === selectedLoanId);
            if (!loan) {
                showMessage('Error: Cliente o pr√©stamo no encontrado.', 'error'); return;
            }

            const totalPagadoCliente = (loan.pagos || []).reduce((sum, p) => sum + p.montoPagado, 0);

            let cuotasPagadasContador = 0;
            if(loan.pagos && loan.cuotaPeriodica > 0) {
                let montoAcumuladoParaCuotas = 0;
                loan.pagos.forEach(p => {
                    if(p.tipoPago === 'interes_capital') montoAcumuladoParaCuotas += (p.montoPagado - (p.montoAplicadoAMora || 0)); // Sum amount applied to P+I
                });
                cuotasPagadasContador = Math.floor(montoAcumuladoParaCuotas / loan.cuotaPeriodica);
            }
            const numCuotasRestantes = Math.max(0, loan.numeroCuotas - cuotasPagadasContador);

            let receiptContent = `<div style="font-family: Arial, sans-serif; font-size: 12px; padding: 15px; border: 1px solid #ccc; max-width: 700px; margin: auto;">`;
            receiptContent += `<h1 style="text-align:center; color:#333; margin-bottom:10px;">Recibo de Estado de Cuenta</h1>`;
            receiptContent += `<p style="text-align:right; font-size:10px;"><strong>Fecha Emisi√≥n:</strong> ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</p><hr style="margin:10px 0;">`;
            receiptContent += `<h3>Datos del Cliente</h3>`;
            receiptContent += `<p><strong>Nombre:</strong> ${loan.nombre}</p>`;
            if(loan.direccion) receiptContent += `<p><strong>Direcci√≥n:</strong> ${loan.direccion}</p>`;
            if(loan.telefono) receiptContent += `<p><strong>Tel√©fono:</strong> ${loan.telefono}</p>`;
            receiptContent += `<hr style="margin:10px 0;"><h3>Resumen del Pr√©stamo Original</h3>`;
            receiptContent += `<p><strong>Monto Original del Cr√©dito:</strong> RD$${formatNumberRD(loan.importeCredito)}</p>`;
            receiptContent += `<p><strong>Inter√©s Original Estimado:</strong> RD$${formatNumberRD(loan.interesTotal || 0)}</p>`;
            if (loan.llevoContrato === 'Si' && loan.costoContrato > 0.005) {
                 receiptContent += `<p><strong>Costo Contrato:</strong> RD$${formatNumberRD(loan.costoContrato)} (${loan.costoContratoPagadoAdelantado === 'Si' ? 'Pagado por adelantado' : 'Incluido en financiamiento'})\n`;
            }
            receiptContent += `<p><strong>Total Adeudado Original (sin mora):</strong> RD$${formatNumberRD(loan.totalPagarOriginal || loan.totalPagar)}</p>`;
            receiptContent += `<hr style="margin:10px 0;"><h3>Estado Actual del Pr√©stamo</h3>`;
            receiptContent += `<p><strong>Mora Acumulada (Cargada al Saldo):</strong> RD$${formatNumberRD(loan.moraAcumulada || 0)}</p>`;
            receiptContent += `<p><strong>Total Pagado hasta la Fecha:</strong> RD$${formatNumberRD(totalPagadoCliente)}</p>`;
            receiptContent += `<p style="font-weight:bold; font-size:1.2em; color:${loan.saldoPendiente > 0.005 ? '#D32F2F' : '#388E3C'};">SALDO PENDIENTE ACTUAL (incluye mora): RD$${formatNumberRD(loan.saldoPendiente)}</p>`;
            receiptContent += `<hr style="margin:10px 0;"><h3>Detalle de Cuotas (Estimado)</h3>`;
            receiptContent += `<p><strong>N√∫mero Original de Cuotas:</strong> ${loan.numeroCuotas}</p>`;
            receiptContent += `<p><strong>Cuotas Consideradas Cubiertas (aprox.):</strong> ${cuotasPagadasContador}</p>`;
            receiptContent += `<p><strong>Cuotas Originales Pendientes (Estimado):</strong> ${numCuotasRestantes}</p>`;
            receiptContent += `<p><strong>Monto por Cuota (Original):</strong> RD$${formatNumberRD(loan.cuotaPeriodica)}</p>`;

            if (loan.pagos && loan.pagos.length > 0) {
                receiptContent += `<h4 style="margin-top:15px;">Historial de √öltimos Pagos Registrados</h4>`;
                receiptContent += `<table border="1" style="width:100%; border-collapse:collapse; font-size:10px;"><thead><tr style="background-color:#f0f0f0;"><th style="padding:3px;">Fecha</th><th style="padding:3px;">Monto Pagado</th><th style="padding:3px;">Tipo</th><th style="padding:3px;">Mora Cubierta</th><th>Notas</th></tr></thead><tbody>`;
                const pagosAMostrar = loan.pagos.slice(-5);
                pagosAMostrar.forEach(p => {
                    receiptContent += `<tr><td style="padding:3px;">${p.fechaPago}</td><td style="padding:3px; text-align:right;">RD$${formatNumberRD(p.montoPagado)}</td><td style="padding:3px;">${p.tipoPagoLabel}</td><td style="padding:3px; text-align:right;">RD$${formatNumberRD(p.montoAplicadoAMora || 0)}</td><td style="padding:3px;">${p.notasPago || '-'}</td></tr>`;
                });
                receiptContent += `</tbody></table>`;
            }

            receiptContent += `<br><br><p style="text-align:center;">_________________________<br>Firma del Cliente (Recibido Conforme)</p>`;
            receiptContent += `<p style="font-size:9px; text-align:center; margin-top:20px;">Este es un recibo informativo. El saldo pendiente es el monto final adeudado a la fecha de emisi√≥n.</p></div>`;

            printArea.innerHTML = receiptContent;
            printArea.classList.remove('hidden'); window.print(); printArea.classList.add('hidden'); printArea.innerHTML = '';
            globalPrintOptionsModal.style.display = 'none';
        }

        // --- LISTENERS DE EVENTOS GENERALES DEL FORMULARIO PRINCIPAL ---
        calculateBtn.addEventListener('click', () => {
            if (calculateLoan()) {
                showMessage('C√°lculo realizado. Revise los resultados mostrados.', 'info');
            }
        });

        saveBtn.addEventListener('click', saveData);

        clearBtn.addEventListener('click', clearForm);

    </script>
</body>
</html>
